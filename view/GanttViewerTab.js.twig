{# @copyright   Copyright (C) 2010-2020 Combodo SARL #}
{# @license     http://opensource.org/licenses/AGPL-3.0 #}


var aKBFilesToLoad = [

    // CSS
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/platform.css?v=$sModuleVersion", type: "text" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/dateField/jquery.dateField.css?v=$sModuleVersion", type: "text" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/gantt.css?v=$sModuleVersion", type: "text" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttPrint.css?v=$sModuleVersion", type: "text" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/valueSlider/mb.slider.css?v=$sModuleVersion", type: "text" },
    // JS
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/jquery.livequery.1.1.1.min.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/jquery.timers.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/utilities.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/forms.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/date.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/dialogs.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/layout.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/i18nJs.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/dateField/jquery.dateField.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/JST/jquery.JST.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/valueSlider/jquery.mb.slider.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/svg/jquery.svg.min.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/libs/jquery/svg/jquery.svgdom.1.8.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttUtilities.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttTask.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttDrawerSVG.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttZoom.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttGridEditor.js?v=$sModuleVersion", type: "script" },
    { url: "{$sAbsUrlModulesRoot}combodo-gantt-view/asset/lib/jQueryGantt/ganttMaster.js?v=$sModuleVersion", type: "script" },
];
//var fKBInitCallback = function(){ $('#{$sId}').gantt_handler({$sOptionsAsJson}); };
var iKBCurrentIdx = 0;
var iKBFilesToLoadCount = aKBFilesToLoad.length;
var fKBLoadScript = function(){
    $.when(
        $.ajax({
            url: aKBFilesToLoad[iKBCurrentIdx].url,
            dataType: aKBFilesToLoad[iKBCurrentIdx].type,
            cache: true
        })
            .done(function(){
                if ( (aKBFilesToLoad[iKBCurrentIdx].type === 'text') && ($('head link[type="text/css"][href="' + aKBFilesToLoad[iKBCurrentIdx].url + '"]').length === 0) )
                {
                    $('<link rel="stylesheet" type="text/css" href="' + aKBFilesToLoad[iKBCurrentIdx].url + '" />').appendTo('head');
                }
            })
    )
        .then(function(){
            iKBCurrentIdx++;
            if (iKBCurrentIdx !== iKBFilesToLoadCount)
            {
                fKBLoadScript();
            }
           /* else
            {
                fKBInitCallback();
            }*/
        });
};
fKBLoadScript();


var ge;
$(function() {
    var canWrite=true; //this is the default for test purposes

    // here starts gantt initialization
    ge = new GanttMaster();
    ge.set100OnClose=true;

    ge.shrinkParent=true;

    ge.init($("#workSpace"));
    loadI18n(); //overwrite with localized ones

    //in order to force compute the best-fitting zoom level
    delete ge.gantt.zoom;

    var project=loadGanttFromServer(0,alert);

});

function loadGanttFromServer(taskId, callback) {
    $.post('http://localhost/itopextension/iTop/extensions/combodo-gantt-view/ajax.php?operation=GetProject',
        null,null,'json')
        .done(function(data){
            ret=data;

            ge.loadProject(ret);
            ge.checkpoint(); //empty the undo stack
        });
    return ret;
}


function saveGanttOnServer() {

    //this is a simulation: save data to the local storage or to the textarea

    /*
	var prj = ge.saveProject();

	delete prj.resources;
	delete prj.roles;

	var prof = new Profiler("saveServerSide");
	prof.reset();

	if (ge.deletedTaskIds.length>0) {
	  if (!confirm("TASK_THAT_WILL_BE_REMOVED\n"+ge.deletedTaskIds.length)) {
		return;
	  }
	}

	$.ajax("ganttAjaxController.jsp", {
	  dataType:"json",
	  data: {CM:"SVPROJECT",prj:JSON.stringify(prj)},
	  type:"POST",

	  success: function(response) {
		if (response.ok) {
		  prof.stop();
		  if (response.project) {
			ge.loadProject(response.project); //must reload as "tmp_" ids are now the good ones
		  } else {
			ge.reset();
		  }
		} else {
		  var errMsg="Errors saving project\n";
		  if (response.message) {
			errMsg=errMsg+response.message+"\n";
		  }

		  if (response.errorMessages.length) {
			errMsg += response.errorMessages.join("\n");
		  }

		  alert(errMsg);
		}
	  }

	});
	*/
}

//-------------------------------------------  Get project file as JSON (used for migrate project from gantt to Teamwork) ------------------------------------------------------
function getFile() {
    $("#gimBaPrj").val(JSON.stringify(ge.saveProject()));
    $("#gimmeBack").submit();
    $("#gimBaPrj").val("");

    /*  var uriContent = "data:text/html;charset=utf-8," + encodeURIComponent(JSON.stringify(prj));
	 neww=window.open(uriContent,"dl");*/
}

function showBaselineInfo (event,element){
    //alert(element.attr("data-label"));
    $(element).showBalloon(event, $(element).attr("data-label"));
    ge.splitter.secondBox.one("scroll",function(){
        $(element).hideBalloon();
    })
}
